name: RSDKv3 iOS (Unified Headers)

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build RSDKv3 iOS
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout RSDKv3
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Build Environment
        run: |
          echo "IOS_SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)" >> $GITHUB_ENV
          echo "MIN_VER=13.0" >> $GITHUB_ENV
          
          # Create a unified install directory for ALL libraries (Static libs + Headers)
          WORK_DIR=$(pwd)/build_libs
          INSTALL_DIR=$WORK_DIR/install
          INCLUDE_DIR=$INSTALL_DIR/include
          LIB_DIR=$INSTALL_DIR/lib
          
          mkdir -p $INCLUDE_DIR
          mkdir -p $LIB_DIR
          
          echo "WORK_DIR=$WORK_DIR" >> $GITHUB_ENV
          echo "INSTALL_DIR=$INSTALL_DIR" >> $GITHUB_ENV
          echo "INCLUDE_DIR=$INCLUDE_DIR" >> $GITHUB_ENV
          echo "LIB_DIR=$LIB_DIR" >> $GITHUB_ENV

      - name: Compile Ogg, Vorbis, Theora
        run: |
          cd ${{ env.WORK_DIR }}
          export CC="xcrun -sdk iphoneos clang"
          export CXX="xcrun -sdk iphoneos clang++"
          
          # Download config scripts
          curl -L "https://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.guess;hb=HEAD" -o config.guess
          curl -L "https://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.sub;hb=HEAD" -o config.sub
          chmod +x config.guess config.sub

          export CFLAGS="-arch arm64 -isysroot ${{ env.IOS_SDK_PATH }} -miphoneos-version-min=${{ env.MIN_VER }} -I${{ env.INCLUDE_DIR }}"
          export LDFLAGS="-arch arm64 -isysroot ${{ env.IOS_SDK_PATH }} -miphoneos-version-min=${{ env.MIN_VER }} -L${{ env.LIB_DIR }}"
          
          # 1. OGG
          echo ">>> Building Ogg..."
          curl -LO https://downloads.xiph.org/releases/ogg/libogg-1.3.5.tar.gz
          tar -xf libogg-1.3.5.tar.gz
          cd libogg-1.3.5
          cp ../config.guess . && cp ../config.sub .
          ./configure --host=aarch64-apple-darwin --prefix=${{ env.INSTALL_DIR }} --enable-static --disable-shared
          make -j4 && make install
          cd ..

          # 2. VORBIS
          echo ">>> Building Vorbis..."
          curl -LO https://downloads.xiph.org/releases/vorbis/libvorbis-1.3.7.tar.gz
          tar -xf libvorbis-1.3.7.tar.gz
          cd libvorbis-1.3.7
          cp ../config.guess . && cp ../config.sub .
          sed -i '' 's/-force_cpusubtype_ALL//g' configure
          ./configure --host=aarch64-apple-darwin --prefix=${{ env.INSTALL_DIR }} --enable-static --disable-shared --with-ogg=${{ env.INSTALL_DIR }}
          make -j4 && make install
          cd ..

          # 3. THEORA
          echo ">>> Building Theora..."
          curl -LO https://downloads.xiph.org/releases/theora/libtheora-1.1.1.tar.gz
          tar -xf libtheora-1.1.1.tar.gz
          cd libtheora-1.1.1
          cp ../config.guess . && cp ../config.sub .
          sed -i '' 's/-force_cpusubtype_ALL//g' configure
          ./configure --host=aarch64-apple-darwin --prefix=${{ env.INSTALL_DIR }} --enable-static --disable-shared --disable-examples --disable-spec --disable-asm --with-ogg=${{ env.INSTALL_DIR }} --with-vorbis=${{ env.INSTALL_DIR }}
          make -j4 && make install
          cd ..

      - name: Checkout SDL2
        uses: actions/checkout@v4
        with:
          repository: libsdl-org/SDL
          ref: release-2.28.5
          path: SDL2_Source

      - name: Compile SDL2
        run: |
          cd SDL2_Source/Xcode/SDL
          
          # Build Static Library
          xcodebuild -project SDL.xcodeproj \
            -target "Static Library-iOS" \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            SYMROOT=../../build \
            IPHONEOS_DEPLOYMENT_TARGET=${{ env.MIN_VER }}

          # Copy Libs to Unified Dir
          cp ../../build/Release-iphoneos/libSDL2.a ${{ env.LIB_DIR }}/libSDL2.a
          
          # Copy Headers to Unified Dir (Critical Step)
          # We copy them twice: once to include/ and once to include/SDL2/
          # This ensures both <SDL.h> and <SDL2/SDL.h> work.
          cp -R ../../include/* ${{ env.INCLUDE_DIR }}/
          mkdir -p ${{ env.INCLUDE_DIR }}/SDL2
          cp -R ../../include/* ${{ env.INCLUDE_DIR }}/SDL2/

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Fix Assets & Source
        run: |
          # Reset Assets
          rm -rf dependencies/mac/Assets.xcassets
          mkdir -p dependencies/mac/Assets.xcassets
          echo '{"info" : {"version" : 1, "author" : "xcode"}}' > dependencies/mac/Assets.xcassets/Contents.json

          # Patch cocoaHelpers.mm (Remove AppKit dependency)
          echo "// Empty file to bypass AppKit dependency on iOS" > dependencies/mac/cocoaHelpers.mm

          # Fix OpenGL include for iOS (ES2)
          # Ensure we include the Apple specific headers if standard GL headers fail
          sed -i '' 's|#include <GL/glew.h>|#include <OpenGLES/ES2/gl.h>\n#include <OpenGLES/ES2/glext.h>|g' RSDKv3/RetroEngine.hpp

          # Create dummy data for build
          mkdir -p dependencies/ios
          touch dependencies/ios/Data.rsdk
          touch dependencies/ios/Default.png

      - name: Build iOS Project
        run: |
          # Define paths explicitly
          PROJ_FILE="RSDKv3 ios.xcodeproj"
          UNIFIED_INCLUDE="${{ env.INCLUDE_DIR }}"
          UNIFIED_LIB="${{ env.LIB_DIR }}"
          
          echo ">>> Building with Include Path: $UNIFIED_INCLUDE"

          xcodebuild clean build \
            -project "$PROJ_FILE" \
            -scheme "RSDKv3" \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            ASSETCATALOG_COMPILER_APPICON_NAME="" \
            ASSETCATALOG_COMPILER_LAUNCHIMAGE_NAME="" \
            GCC_TREAT_WARNINGS_AS_ERRORS=NO \
            WARNING_CFLAGS="-w" \
            GCC_PREPROCESSOR_DEFINITIONS='$(inherited) RETRO_PLATFORM=RETRO_iOS RETRO_RENDERDEVICE=RETRO_GLES2' \
            HEADER_SEARCH_PATHS='$(inherited) $(PROJECT_DIR)/RSDKv3 '"$UNIFIED_INCLUDE" \
            LIBRARY_SEARCH_PATHS='$(inherited) '"$UNIFIED_LIB" \
            OTHER_LDFLAGS='$(inherited) -lSDL2 -logg -lvorbis -ltheora -framework OpenGLES -framework AudioToolbox -framework CoreAudio -framework CoreGraphics -framework QuartzCore -framework UIKit -framework Foundation -framework CoreMotion -framework GameController -framework AVFoundation'

          # Package
          mkdir -p build_output
          find . -name "*.app" -print0 | xargs -0 -I {} cp -R {} build_output/
          
          cd build_output
          APP_NAME=$(find . -name "*.app" -maxdepth 1 | head -n 1)
          if [ -z "$APP_NAME" ]; then
             echo "Error: No .app found in build output!"
             exit 1
          fi
          
          mkdir Payload
          mv "$APP_NAME" Payload/
          zip -r RSDKv3.ipa Payload

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RSDKv3-iOS-IPA
          path: build_output/RSDKv3.ipa
