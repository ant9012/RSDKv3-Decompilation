name: RSDKv3 iOS (Final Env Fix)

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build RSDKv3
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
      - name: Checkout RSDKv3
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Build Environment
        run: |
          # 1. Get iOS SDK Path
          echo "IOS_SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)" >> $GITHUB_ENV
          echo "MIN_VER=12.0" >> $GITHUB_ENV
          
          # 2. Create a central install directory
          WORK_DIR=$(pwd)/build_libs
          INSTALL_DIR=$WORK_DIR/install
          mkdir -p $INSTALL_DIR
          echo "WORK_DIR=$WORK_DIR" >> $GITHUB_ENV
          echo "INSTALL_DIR=$INSTALL_DIR" >> $GITHUB_ENV
          
          # NOTE: We do NOT export CC/CXX here anymore to avoid breaking Xcode later.

      - name: Compile Ogg, Vorbis, Theora
        run: |
          cd ${{ env.WORK_DIR }}
          
          # --- DEFINE COMPILERS LOCALLY ---
          # These variables now only exist inside this specific step
          export CC="xcrun -sdk iphoneos clang"
          export CXX="xcrun -sdk iphoneos clang++"
          
          # --- DOWNLOAD MODERN CONFIG SCRIPTS ---
          curl -L "https://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.guess;hb=HEAD" -o config.guess
          curl -L "https://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.sub;hb=HEAD" -o config.sub
          chmod +x config.guess config.sub

          # --- COMMON FLAGS ---
          export CFLAGS="-arch arm64 -isysroot ${{ env.IOS_SDK_PATH }} -miphoneos-version-min=${{ env.MIN_VER }} -I${{ env.INSTALL_DIR }}/include"
          export LDFLAGS="-arch arm64 -isysroot ${{ env.IOS_SDK_PATH }} -miphoneos-version-min=${{ env.MIN_VER }} -L${{ env.INSTALL_DIR }}/lib"
          export PKG_CONFIG_PATH="${{ env.INSTALL_DIR }}/lib/pkgconfig"
          
          # --- 1. COMPILE LIBOGG ---
          echo ">>> Building Ogg..."
          curl -LO https://downloads.xiph.org/releases/ogg/libogg-1.3.5.tar.gz
          tar -xf libogg-1.3.5.tar.gz
          cd libogg-1.3.5
          cp ../config.guess . && cp ../config.sub .
          
          ./configure --host=aarch64-apple-darwin --prefix=${{ env.INSTALL_DIR }} --enable-static --disable-shared
          make -j4 && make install
          cd ..

          # --- 2. COMPILE LIBVORBIS ---
          echo ">>> Building Vorbis..."
          curl -LO https://downloads.xiph.org/releases/vorbis/libvorbis-1.3.7.tar.gz
          tar -xf libvorbis-1.3.7.tar.gz
          cd libvorbis-1.3.7
          cp ../config.guess . && cp ../config.sub .
          sed -i '' 's/-force_cpusubtype_ALL//g' configure
          
          ./configure --host=aarch64-apple-darwin --prefix=${{ env.INSTALL_DIR }} --enable-static --disable-shared --with-ogg=${{ env.INSTALL_DIR }}
          make -j4 && make install
          cd ..

          # --- 3. COMPILE LIBTHEORA ---
          echo ">>> Building Theora..."
          curl -LO https://downloads.xiph.org/releases/theora/libtheora-1.1.1.tar.gz
          tar -xf libtheora-1.1.1.tar.gz
          cd libtheora-1.1.1
          cp ../config.guess . && cp ../config.sub .
          sed -i '' 's/-force_cpusubtype_ALL//g' configure
          
          ./configure --host=aarch64-apple-darwin --prefix=${{ env.INSTALL_DIR }} --enable-static --disable-shared --disable-examples --disable-spec --disable-asm --with-ogg=${{ env.INSTALL_DIR }} --with-vorbis=${{ env.INSTALL_DIR }}
          make -j4 && make install
          cd ..

      - name: Package Libraries into Frameworks
        run: |
          SRC_DIR="${{ env.INSTALL_DIR }}"
          DEST_DIR="dependencies/ios"
          mkdir -p $DEST_DIR

          make_framework() {
            NAME=$1
            LIB_FILE=$2
            HEADER_DIR=$3
            FW_PATH="$DEST_DIR/$NAME.framework"
            rm -rf "$FW_PATH" && mkdir -p "$FW_PATH/Headers"
            cp "$SRC_DIR/lib/$LIB_FILE" "$FW_PATH/$NAME"
            if [ -d "$SRC_DIR/include/$HEADER_DIR" ]; then
                cp -r "$SRC_DIR/include/$HEADER_DIR/"* "$FW_PATH/Headers/"
            else
                cp "$SRC_DIR/include/"*.h "$FW_PATH/Headers/"
            fi
            echo '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>CFBundleExecutable</key><string>'$NAME'</string><key>CFBundleIdentifier</key><string>org.xiph.'$NAME'</string><key>CFBundlePackageType</key><string>FMWK</string><key>CFBundleShortVersionString</key><string>1.0</string><key>CFBundleVersion</key><string>1</string><key>MinimumOSVersion</key><string>12.0</string></dict></plist>' > "$FW_PATH/Info.plist"
          }

          make_framework "Ogg" "libogg.a" "ogg"
          make_framework "Vorbis" "libvorbis.a" "vorbis"
          make_framework "Theora" "libtheora.a" "theora"

      - name: Checkout SDL2
        uses: actions/checkout@v4
        with:
          repository: libsdl-org/SDL
          ref: release-2.28.5
          path: SDL2_Source

      - name: Compile SDL2
        run: |
          # Go to the inner SDL Xcode project folder
          cd SDL2_Source/Xcode/SDL
          
          # Force deployment target to match our environment to avoid warnings/errors
          export IPHONEOS_DEPLOYMENT_TARGET=12.0
          
          # 1. Build Framework
          # Note: We do NOT set CC or CXX here, so Xcode uses its defaults.
          xcodebuild -project SDL.xcodeproj \
            -target "Framework-iOS" \
            -configuration Release \
            -sdk iphoneos \
            -quiet \
            SYMROOT=../../build \
            IPHONEOS_DEPLOYMENT_TARGET=12.0
          
          # 2. Build Static Lib (libSDL2.a)
          xcodebuild -project SDL.xcodeproj \
            -target "libSDL2" \
            -configuration Release \
            -sdk iphoneos \
            -quiet \
            SYMROOT=../../build \
            IPHONEOS_DEPLOYMENT_TARGET=12.0
          
          # 3. Copy files to dependencies
          TARGET_DIR="../../../dependencies/ios/SDL2"
          mkdir -p $TARGET_DIR
          
          cp -R ../../build/Release-iphoneos/SDL2.framework $TARGET_DIR/
          cp -R ../../build/Release-iphoneos/hidapi.framework $TARGET_DIR/
          cp ../../build/Release-iphoneos/libSDL2.a $TARGET_DIR/libSDL2Main.a

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Build RSDKv3 IPA
        run: |
          xcodebuild clean build \
            -project "RSDKv3.xcodeproj" \
            -scheme "RSDKv3" \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES

      - name: Package and Upload IPA
        run: |
          cd build/Release-iphoneos/
          mkdir Payload
          mv RSDKv3.app Payload/
          zip -r RSDKv3.ipa Payload
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: RSDKv3-iOS-IPA
          path: build/Release-iphoneos/RSDKv3.ipa
