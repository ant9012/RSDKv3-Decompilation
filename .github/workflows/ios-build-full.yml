name: RSDKv3 iOS (Manual Compile)

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build:
    name: Build All Deps & Game
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      # 1. Checkout Code
      - name: Checkout RSDKv3
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. Setup Environment Variables for Cross-Compilation
      # This tells the compiler where the iOS SDK is located on the runner.
      - name: Setup Build Environment
        run: |
          echo "IOS_SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)" >> $GITHUB_ENV
          echo "MIN_VER=12.0" >> $GITHUB_ENV
          echo "ARCH_FLAGS=-arch arm64" >> $GITHUB_ENV

      # 3. Compile Audio Libraries (The Hard Part)
      # We manually download sources and run standard ./configure with iOS flags
      - name: Compile Ogg, Vorbis, Theora
        run: |
          # Create a temporary build directory
          mkdir -p build_libs
          cd build_libs
          BUILD_ROOT=$(pwd)
          INSTALL_DIR=$BUILD_ROOT/install
          mkdir -p $INSTALL_DIR

          # --- 1. COMPILE LIBOGG ---
          echo "Downloading Ogg..."
          curl -LO https://downloads.xiph.org/releases/ogg/libogg-1.3.5.tar.gz
          tar -xf libogg-1.3.5.tar.gz
          cd libogg-1.3.5
          
          # Configure for iOS arm64
          ./configure \
            --host=aarch64-apple-darwin \
            --prefix=$INSTALL_DIR \
            --enable-static \
            --disable-shared \
            CC="xcrun -sdk iphoneos clang" \
            CFLAGS="-arch arm64 -isysroot $IOS_SDK_PATH -miphoneos-version-min=$MIN_VER" \
            LDFLAGS="-arch arm64 -isysroot $IOS_SDK_PATH -miphoneos-version-min=$MIN_VER"

          make -j4 && make install
          cd ..

          # --- 2. COMPILE LIBVORBIS ---
          echo "Downloading Vorbis..."
          curl -LO https://downloads.xiph.org/releases/vorbis/libvorbis-1.3.7.tar.gz
          tar -xf libvorbis-1.3.7.tar.gz
          cd libvorbis-1.3.7

          # Configure for iOS (Pointing to our custom Ogg build)
          ./configure \
            --host=aarch64-apple-darwin \
            --prefix=$INSTALL_DIR \
            --enable-static \
            --disable-shared \
            --with-ogg=$INSTALL_DIR \
            CC="xcrun -sdk iphoneos clang" \
            CFLAGS="-arch arm64 -isysroot $IOS_SDK_PATH -miphoneos-version-min=$MIN_VER" \
            LDFLAGS="-arch arm64 -isysroot $IOS_SDK_PATH -miphoneos-version-min=$MIN_VER"

          make -j4 && make install
          cd ..

          # --- 3. COMPILE LIBTHEORA ---
          # (Optional: Only if you need video. RSDKv3 uses it.)
          echo "Downloading Theora..."
          curl -LO https://downloads.xiph.org/releases/theora/libtheora-1.1.1.tar.gz
          tar -xf libtheora-1.1.1.tar.gz
          cd libtheora-1.1.1
          
          # Theora config script is old and might guess the host wrong, so we force it carefully
          # We also disable examples and spec to save compile time/errors
          ./configure \
            --host=aarch64-apple-darwin \
            --prefix=$INSTALL_DIR \
            --enable-static \
            --disable-shared \
            --disable-examples \
            --disable-spec \
            --with-ogg=$INSTALL_DIR \
            --with-vorbis=$INSTALL_DIR \
            CC="xcrun -sdk iphoneos clang" \
            CFLAGS="-arch arm64 -isysroot $IOS_SDK_PATH -miphoneos-version-min=$MIN_VER -Wno-implicit-function-declaration" \
            LDFLAGS="-arch arm64 -isysroot $IOS_SDK_PATH -miphoneos-version-min=$MIN_VER"

          make -j4 && make install
          cd ..

      # 4. Package Libraries into Frameworks
      # Move the compiled .a files into the structure RSDKv3 expects
      - name: Create Framework Structure
        run: |
          SRC_DIR="build_libs/install"
          DEST_DIR="dependencies/ios"
          mkdir -p $DEST_DIR

          # Helper function to make a framework folder
          make_framework() {
            NAME=$1
            LIB_FILE=$2
            HEADER_DIR=$3
            
            FW_PATH="$DEST_DIR/$NAME.framework"
            rm -rf "$FW_PATH"
            mkdir -p "$FW_PATH/Headers"
            
            # Copy lib and headers
            cp "$SRC_DIR/lib/$LIB_FILE" "$FW_PATH/$NAME"
            cp -r "$SRC_DIR/include/$HEADER_DIR/"* "$FW_PATH/Headers/"
            
            # Create Dummy Info.plist
            echo '<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"><plist version="1.0"><dict><key>CFBundleExecutable</key><string>'$NAME'</string><key>CFBundleIdentifier</key><string>org.xiph.'$NAME'</string><key>CFBundlePackageType</key><string>FMWK</string><key>CFBundleShortVersionString</key><string>1.0</string><key>CFBundleVersion</key><string>1</string><key>MinimumOSVersion</key><string>12.0</string></dict></plist>' > "$FW_PATH/Info.plist"
          }

          make_framework "Ogg" "libogg.a" "ogg"
          make_framework "Vorbis" "libvorbis.a" "vorbis"
          make_framework "Theora" "libtheora.a" "theora"
          
          echo "Frameworks created in $DEST_DIR"
          ls -R $DEST_DIR

      # 5. Build SDL2 (Using Xcode directly as it's cleaner for SDL)
      - name: Checkout SDL2
        uses: actions/checkout@v4
        with:
          repository: libsdl-org/SDL
          ref: release-2.28.5
          path: SDL2_Source

      - name: Compile SDL2
        run: |
          cd SDL2_Source/Xcode
          
          # Framework
          xcodebuild -project SDL.xcodeproj -target "Framework-iOS" -configuration Release -sdk iphoneos -quiet SYMROOT=../build
          
          # Static Lib (Main)
          xcodebuild -project SDL.xcodeproj -target "libSDL2" -configuration Release -sdk iphoneos -quiet SYMROOT=../build
          
          # Move to dependencies
          TARGET_DIR="../../dependencies/ios/SDL2"
          mkdir -p $TARGET_DIR
          
          cp -R ../build/Release-iphoneos/SDL2.framework $TARGET_DIR/
          cp -R ../build/Release-iphoneos/hidapi.framework $TARGET_DIR/
          cp ../build/Release-iphoneos/libSDL2.a $TARGET_DIR/libSDL2Main.a

      # 6. Setup Xcode
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      # 7. Final Build
      - name: Build RSDKv3 IPA
        run: |
          xcodebuild clean build \
            -project "RSDKv3.xcodeproj" \
            -scheme "RSDKv3" \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES

      # 8. Package & Upload
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: RSDKv3-Manual-Build
          path: build/Release-iphoneos/RSDKv3.app
